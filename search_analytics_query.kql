// ============================================================================
// Search Analytics Query - Dynamic JSON Flattening
// ============================================================================
// Purpose: Extract and flatten search analytics data from Application Insights
//          customEvents table with dynamic column generation.
//
// Data Structure:
//   - customDimensions contains flat key-value pairs:
//     query, message, searchQuery, userDetails, deviceType, userAgent, os,
//     browser, osName, browserName, osVersion, browserVersion, platform,
//     error code, totalSuggestionsCount, suggestionsCount, totalTrendingCount,
//     trendingCount
//   - customDimensions also contains a nested JSON object:
//     CustomProps (with its own dynamic key-value pairs)
//
// Output: All keys become columns dynamically. CustomProps keys are prefixed
//         with "CP_" to distinguish them from top-level keys.
//
// HOW TO USE: Copy from "let TimeRange" to "order by timestamp desc" (lines 24-45)
// ============================================================================


// === COPY FROM HERE ===
set truncationmaxrecords = 500000;
let TimeRange = 90d;
let CustomPropsPrefix = "CP_";
let SearchData = customEvents
    | where timestamp >= ago(TimeRange)
    | where name startswith "Search"
    | extend cd = todynamic(customDimensions)
    | serialize
    | extend rowId = row_number()
    | extend CustomPropsRaw = tostring(cd.CustomProps)
    | extend CP = iff(isnotempty(CustomPropsRaw) and CustomPropsRaw startswith "{", todynamic(CustomPropsRaw), dynamic({}))
    | extend mainBag = bag_remove_keys(cd, dynamic(["CustomProps"]))
    | extend cpKeys = bag_keys(CP)
    | mv-expand cpKey = cpKeys to typeof(string)
    | extend cpBag = pack(strcat(CustomPropsPrefix, cpKey), tostring(CP[cpKey]))
    | summarize take_any(timestamp), take_any(name), take_any(client_CountryOrRegion), take_any(mainBag), cpMerged = make_bag(cpBag) by rowId
    | extend finalBag = bag_merge(mainBag, coalesce(cpMerged, dynamic({})));
SearchData
| evaluate bag_unpack(finalBag)
| project-away rowId, mainBag, cpMerged
| project-reorder timestamp, name, client_CountryOrRegion
| order by timestamp desc
// === COPY TO HERE ===


// ============================================================================
// ALTERNATIVE QUERIES (copy/paste separately)
// ============================================================================

// --- QUERY A: Row-based output (keys as rows instead of columns) ---
// customEvents | where timestamp >= ago(24h) | where name startswith "Search" | extend cd = todynamic(customDimensions) | serialize | extend rowId = row_number() | extend CP = todynamic(tostring(cd.CustomProps)) | extend mainBag = bag_remove_keys(cd, dynamic(["CustomProps"])) | mv-expand kind=array mainKV = mainBag | extend PropertyKey = tostring(mainKV[0]), PropertyValue = tostring(mainKV[1]) | project timestamp, name, rowId, PropertyKey, PropertyValue, Source = "main"

// --- QUERY B: Key discovery - find all unique keys ---
// customEvents | where timestamp >= ago(24h) | where name startswith "Search" | extend cd = todynamic(customDimensions) | extend CP = todynamic(tostring(cd.CustomProps)) | extend mainKeys = bag_keys(bag_remove_keys(cd, dynamic(["CustomProps"]))) | mv-expand mainKey = mainKeys to typeof(string) | summarize KeyCount = count(), SampleValue = take_any(tostring(cd[mainKey])) by Key = mainKey | order by KeyCount desc

// --- QUERY C: Simplified version (no CP_ prefix) ---
// customEvents | where timestamp >= ago(24h) | where name startswith "Search" | extend cd = todynamic(customDimensions) | extend CP = todynamic(tostring(cd.CustomProps)) | extend flatBag = bag_merge(bag_remove_keys(cd, dynamic(["CustomProps"])), coalesce(CP, dynamic({}))) | evaluate bag_unpack(flatBag) | project-reorder timestamp, name | order by timestamp desc

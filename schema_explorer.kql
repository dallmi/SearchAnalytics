// ============================================================================
// Schema Explorer - Discover data structure per event type
// ============================================================================
// Purpose: Map out the full nesting structure of customDimensions per event
//          type (name), detecting nested JSON at every level.
//
// Run each query separately in App Insights > Logs.
// Adjust TimeRange as needed (shorter = faster, longer = more complete).
// ============================================================================


// =========================================================================
// QUERY 1: Full schema map per event type (Level 1 + 2 + 3)
// =========================================================================
// Shows every key path, which level it lives at, whether it contains nested
// JSON, a sample value, and the count of events that have it.
//
// Output columns:
//   EventType    - the event name (e.g. SEARCH_TRIGGERED)
//   Level        - 1 (customDimensions), 2 (CustomProps), 3 (sub-object)
//   KeyPath      - full dot-separated path (e.g. CustomProps.searchPerformance.searchLatency)
//   IsNestedJSON - true if the value is itself a JSON object (deeper nesting exists)
//   SampleValue  - one example value (truncated to 200 chars)
//   EventCount   - how many events contain this key
// =========================================================================
let TimeRange = 30d;
customEvents
| where timestamp >= ago(TimeRange)
| where name startswith "Search" or name has "SEARCH"
| extend cd = todynamic(customDimensions)
// --- Level 1: top-level customDimensions keys ---
| extend mainBag = bag_remove_keys(cd, dynamic(["CustomProps"]))
| extend CustomPropsRaw = tostring(cd.CustomProps)
| extend CP = iff(isnotempty(CustomPropsRaw) and CustomPropsRaw startswith "{", todynamic(CustomPropsRaw), dynamic({}))
| extend mainKeys = bag_keys(mainBag)
| extend cpKeys = bag_keys(CP)
// Expand Level 1 keys
| mv-expand mainKey = mainKeys to typeof(string)
| extend L1_value = tostring(mainBag[mainKey])
| extend L1_isNested = isnotempty(L1_value) and L1_value startswith "{"
// Summarize Level 1
| summarize
    EventCount = count(),
    SampleValue = take_any(L1_value),
    IsNestedJSON = take_any(L1_isNested)
    by EventType = name, KeyPath = mainKey
| extend Level = 1
| union (
    // --- Level 2: CustomProps keys ---
    customEvents
    | where timestamp >= ago(TimeRange)
    | where name startswith "Search" or name has "SEARCH"
    | extend cd = todynamic(customDimensions)
    | extend CP = iff(
        isnotempty(tostring(cd.CustomProps)) and tostring(cd.CustomProps) startswith "{",
        todynamic(tostring(cd.CustomProps)),
        dynamic({}))
    | extend cpKeys = bag_keys(CP)
    | mv-expand cpKey = cpKeys to typeof(string)
    | extend L2_value = tostring(CP[cpKey])
    | extend L2_isNested = isnotempty(L2_value) and L2_value startswith "{"
    | summarize
        EventCount = count(),
        SampleValue = take_any(L2_value),
        IsNestedJSON = take_any(L2_isNested)
        by EventType = name, KeyPath = strcat("CustomProps.", cpKey)
    | extend Level = 2
)
| union (
    // --- Level 3: sub-objects within CustomProps ---
    customEvents
    | where timestamp >= ago(TimeRange)
    | where name startswith "Search" or name has "SEARCH"
    | extend cd = todynamic(customDimensions)
    | extend CP = iff(
        isnotempty(tostring(cd.CustomProps)) and tostring(cd.CustomProps) startswith "{",
        todynamic(tostring(cd.CustomProps)),
        dynamic({}))
    | extend cpKeys = bag_keys(CP)
    | mv-expand cpKey = cpKeys to typeof(string)
    | extend cpValue = tostring(CP[cpKey])
    | where isnotempty(cpValue) and cpValue startswith "{"
    | extend subBag = todynamic(cpValue)
    | extend subKeys = bag_keys(subBag)
    | mv-expand subKey = subKeys to typeof(string)
    | extend L3_value = tostring(subBag[subKey])
    | extend L3_isNested = isnotempty(L3_value) and L3_value startswith "{"
    | summarize
        EventCount = count(),
        SampleValue = take_any(L3_value),
        IsNestedJSON = take_any(L3_isNested)
        by EventType = name, KeyPath = strcat("CustomProps.", cpKey, ".", subKey)
    | extend Level = 3
)
| extend SampleValue = substring(SampleValue, 0, 200)
| project EventType, Level, KeyPath, IsNestedJSON, SampleValue, EventCount
| order by EventType asc, Level asc, KeyPath asc


// =========================================================================
// QUERY 2: Compact summary - event types with their max nesting depth
// =========================================================================
// Quick overview: which event types have deep nesting?
// =========================================================================
// let TimeRange = 30d;
// customEvents
// | where timestamp >= ago(TimeRange)
// | where name startswith "Search" or name has "SEARCH"
// | extend cd = todynamic(customDimensions)
// | extend CustomPropsRaw = tostring(cd.CustomProps)
// | extend hasCP = isnotempty(CustomPropsRaw) and CustomPropsRaw startswith "{"
// | extend CP = iff(hasCP, todynamic(CustomPropsRaw), dynamic({}))
// | extend cpKeys = bag_keys(CP)
// | mv-expand cpKey = cpKeys to typeof(string)
// | extend cpValue = tostring(CP[cpKey])
// | extend hasL3 = isnotempty(cpValue) and cpValue startswith "{"
// | extend subBag = iff(hasL3, todynamic(cpValue), dynamic({}))
// | extend subKeys = bag_keys(subBag)
// | mv-expand subKey = subKeys to typeof(string)
// | extend subValue = iff(subKey == "", "", tostring(subBag[subKey]))
// | extend hasL4 = isnotempty(subValue) and subValue startswith "{"
// | summarize
//     TotalEvents = dcount(timestamp),
//     HasCustomProps = countif(hasCP),
//     HasLevel3 = countif(hasL3),
//     HasLevel4 = countif(hasL4),
//     MaxDepth = case(
//         countif(hasL4) > 0, 4,
//         countif(hasL3) > 0, 3,
//         countif(hasCP) > 0, 2,
//         1),
//     L1_Keys = make_set(bag_keys(bag_remove_keys(cd, dynamic(["CustomProps"])))),
//     L2_Keys = make_set(cpKey),
//     L3_NestedKeys = make_set(iff(hasL3, cpKey, ""))
//     by EventType = name
// | project-away ['L3_NestedKeys']
// | order by MaxDepth desc, TotalEvents desc


// =========================================================================
// QUERY 3: Level 4+ detection - find anything deeper than 3 levels
// =========================================================================
// Run this to check if you need MORE than 3 levels of unnesting.
// Returns only keys where Level 3 values are themselves JSON objects.
// If this returns no rows, 3 levels is sufficient.
// =========================================================================
// let TimeRange = 30d;
// customEvents
// | where timestamp >= ago(TimeRange)
// | where name startswith "Search" or name has "SEARCH"
// | extend cd = todynamic(customDimensions)
// | extend CP = iff(
//     isnotempty(tostring(cd.CustomProps)) and tostring(cd.CustomProps) startswith "{",
//     todynamic(tostring(cd.CustomProps)),
//     dynamic({}))
// | extend cpKeys = bag_keys(CP)
// | mv-expand cpKey = cpKeys to typeof(string)
// | extend cpValue = tostring(CP[cpKey])
// | where isnotempty(cpValue) and cpValue startswith "{"
// | extend subBag = todynamic(cpValue)
// | extend subKeys = bag_keys(subBag)
// | mv-expand subKey = subKeys to typeof(string)
// | extend subValue = tostring(subBag[subKey])
// | where isnotempty(subValue) and subValue startswith "{"
// | summarize
//     EventCount = count(),
//     SampleValue = take_any(substring(subValue, 0, 300))
//     by EventType = name,
//        KeyPath = strcat("CustomProps.", cpKey, ".", subKey)
// | order by EventCount desc

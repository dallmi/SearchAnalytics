# Power BI Visualization Guide for Search Analytics

This guide provides recommended visualizations for analyzing Intranet search behavior using the parquet files generated by the processing script.

---

## Data Sources Setup

### Connecting to Parquet Files
1. **Get Data** > **Parquet**
2. Navigate to `output/` folder
3. Load both files:
   - `searches_daily.parquet` - Daily aggregated metrics
   - `searches_journeys.parquet` - Session-level data

---

## Important: Handling Pre-Calculated Rates and Averages

### The Aggregation Problem

The daily parquet file contains pre-calculated rate and average columns for convenience when viewing single-day data. However, **these columns cannot be correctly aggregated across multiple days** using simple SUM or AVERAGE functions.

**Why?** Averaging percentages or ratios gives mathematically incorrect results:
- Day 1: 50 clicks / 100 searches = 50% CTR
- Day 2: 10 clicks / 200 searches = 5% CTR
- Wrong: Average of 50% and 5% = 27.5%
- Correct: (50 + 10) / (100 + 200) = 20%

### Columns That Cannot Be Directly Aggregated

| Column | Type | Problem |
|--------|------|---------|
| `click_rate_pct` | Ratio | Cannot average percentages |
| `null_rate_pct` | Ratio | Cannot average percentages |
| `session_success_rate_pct` | Ratio | Cannot average percentages |
| `session_abandonment_rate_pct` | Ratio | Cannot average percentages |
| `avg_searches_per_session` | Average | Cannot average averages |
| `avg_search_term_length` | Average | Cannot average averages |
| `avg_search_term_words` | Average | Cannot average averages |

### Solution: Create DAX Measures

Instead of using the pre-calculated columns, create DAX measures that recalculate from the component columns. The daily file includes all necessary building blocks.

#### Rate Metrics - DAX Formulas

```dax
// Click Rate (clicks per search - can exceed 100% if users click multiple results)
Click Rate % =
DIVIDE(
    SUM(searches_daily[click_events]),
    SUM(searches_daily[search_starts]),
    0
) * 100

// Null Result Rate
Null Rate % =
DIVIDE(
    SUM(searches_daily[null_results]),
    SUM(searches_daily[result_events]),
    0
) * 100

// Session Success Rate (sessions with at least one click / sessions with results)
// Always 0-100% - recommended for KPIs
Session Success Rate % =
DIVIDE(
    SUM(searches_daily[sessions_with_clicks]),
    SUM(searches_daily[sessions_with_results]),
    0
) * 100

// Session Abandonment Rate (sessions with results but no clicks / sessions with results)
// Always 0-100% - recommended for KPIs
Session Abandonment Rate % =
DIVIDE(
    SUM(searches_daily[sessions_abandoned]),
    SUM(searches_daily[sessions_with_results]),
    0
) * 100
```

**Note on Click Rate vs Session Success Rate:**
- `Click Rate %` counts events and can exceed 100% (users clicking multiple results per search)
- `Session Success Rate %` is session-based and always 0-100% (did the session have any clicks?)
- Use **Session Success/Abandonment rates** for executive KPIs

#### Average Metrics - DAX Formulas

```dax
// Average Searches per Session
Avg Searches per Session =
DIVIDE(
    SUM(searches_daily[search_starts]),
    SUM(searches_daily[unique_sessions]),
    0
)

// Average Search Term Length (weighted average using SUM columns)
Avg Search Term Length =
DIVIDE(
    SUM(searches_daily[sum_search_term_length]),
    SUM(searches_daily[search_term_count]),
    0
)

// Average Search Term Words (weighted average using SUM columns)
Avg Search Term Words =
DIVIDE(
    SUM(searches_daily[sum_search_term_words]),
    SUM(searches_daily[search_term_count]),
    0
)
```

### Component Columns Reference

| Metric to Calculate | Numerator Column | Denominator Column |
|---------------------|------------------|-------------------|
| Click Rate % | `click_events` | `search_starts` |
| Null Rate % | `null_results` | `result_events` |
| Session Success Rate % | `sessions_with_clicks` | `sessions_with_results` |
| Session Abandonment Rate % | `sessions_abandoned` | `sessions_with_results` |
| Avg Searches/Session | `search_starts` | `unique_sessions` |
| Avg Search Term Length | `sum_search_term_length` | `search_term_count` |
| Avg Search Term Words | `sum_search_term_words` | `search_term_count` |

### When to Use Pre-Calculated vs DAX Measures

| Scenario | Use Pre-Calculated Column | Use DAX Measure |
|----------|---------------------------|-----------------|
| Single day view (date slicer = 1 day) | OK | OK |
| Multiple days aggregated | NO | YES |
| Weekly/Monthly totals | NO | YES |
| Filtering by other dimensions | NO | YES |
| Quick glance at daily table | OK | OK |

### Best Practice

**Always use DAX measures for KPI tiles and aggregated views.** The pre-calculated columns are useful for:
- Quick reference in detailed daily tables
- Validation that your DAX measures match single-day values
- Export to other tools that will handle aggregation separately

---

## Page 1: Executive Dashboard (Daily Metrics)

### Row 1: KPI Tiles

| Tile | Measure | Description |
|------|---------|-------------|
| **Total Searches** | `SUM(search_starts)` | Total search queries |
| **Unique Users** | `SUM(unique_users)` | Distinct users who searched |
| **Session Success Rate** | See DAX below | Percentage of sessions with results that had clicks |
| **Null Result Rate** | See DAX below | Percentage of searches with zero results |
| **Session Abandonment Rate** | See DAX below | Percentage of sessions with results but no clicks |

#### DAX Measures for Correct Aggregation

```dax
// Session Success Rate (always 0-100%)
Session Success Rate % =
DIVIDE(
    SUM(searches_daily[sessions_with_clicks]),
    SUM(searches_daily[sessions_with_results]),
    0
) * 100

// Session Abandonment Rate (always 0-100%)
Session Abandonment Rate % =
DIVIDE(
    SUM(searches_daily[sessions_abandoned]),
    SUM(searches_daily[sessions_with_results]),
    0
) * 100

// Null Result Rate
Null Rate % =
DIVIDE(
    SUM(searches_daily[null_results]),
    SUM(searches_daily[result_events]),
    0
) * 100

// Click Rate (can exceed 100% - multiple clicks per search)
Click Rate % =
DIVIDE(
    SUM(searches_daily[click_events]),
    SUM(searches_daily[search_starts]),
    0
) * 100

// Average Searches per Session
Avg Searches/Session =
DIVIDE(
    SUM(searches_daily[search_starts]),
    SUM(searches_daily[unique_sessions]),
    0
)

// Average Search Term Length (weighted)
Avg Search Term Length =
DIVIDE(
    SUM(searches_daily[sum_search_term_length]),
    SUM(searches_daily[search_term_count]),
    0
)
```

### Row 2: Trend Charts

#### Chart 1: Search Volume Over Time
- **Type**: Line Chart
- **X-Axis**: `date`
- **Y-Axis**: `search_starts`
- **Secondary Y-Axis** (optional): `unique_users`

#### Chart 2: Quality Metrics Over Time
- **Type**: Line Chart (multiple series)
- **X-Axis**: `date`
- **Lines**:
  - `Session Success Rate %` (DAX measure)
  - `Null Rate %` (DAX measure)
  - `Session Abandonment Rate %` (DAX measure)

### Row 3: Click Distribution

#### Chart 3: Clicks by Category
- **Type**: Stacked Bar Chart or Donut
- **Values**:
  - `clicks_general`
  - `clicks_all`
  - `clicks_news`
  - `clicks_goto`
  - `clicks_people`

#### Chart 4: Daily Activity Table
- **Type**: Table
- **Columns**: `date`, `search_starts`, `unique_users`, `Session Success Rate %`, `Null Rate %`
- **Conditional Formatting**: Highlight low success rates or high null rates

---

## Page 2: User Journey Analysis (Session Metrics)

### Understanding the Journeys File

The `searches_journeys.parquet` file contains **one row per session**. Each row represents a complete user journey from first search to last action.

**Key columns:**

| Column | Type | Description |
|--------|------|-------------|
| `session_date` | Date | Date of the session |
| `journey_outcome` | String | Success, Abandoned, No Results, Unknown |
| `search_count_in_session` | Integer | Number of searches in this session |
| `result_count` | Integer | Number of SEARCH_RESULT_COUNT events |
| `click_count` | Integer | Number of clicks |
| `null_result_count` | Integer | Number of searches with 0 results |
| `had_reformulation` | Boolean | Did user search multiple different terms? |
| `session_complexity` | String | Single Event, Simple, Medium, Complex |
| `search_to_result_bucket` | String | Time bucket for search-to-result |
| `result_to_click_bucket` | String | Time bucket for result-to-click |
| `session_duration_bucket` | String | Time bucket for total session duration |
| `sec_search_to_result` | Decimal | Seconds from search to result |
| `sec_result_to_click` | Decimal | Seconds from result to click |
| `total_duration_sec` | Decimal | Total session duration in seconds |
| `search_to_result_sort` | Integer | Sort order for search_to_result_bucket |
| `result_to_click_sort` | Integer | Sort order for result_to_click_bucket |
| `session_duration_sort` | Integer | Sort order for session_duration_bucket |
| `journey_outcome_sort` | Integer | Sort order for journey_outcome |
| `session_complexity_sort` | Integer | Sort order for session_complexity |

### DAX Measures for Journeys

Create these measures for the journeys visualizations:

```dax
// Basic session count
Session Count = COUNTROWS(searches_journeys)

// Journey Outcome Counts
Success Sessions =
CALCULATE(
    COUNTROWS(searches_journeys),
    searches_journeys[journey_outcome] = "Success"
)

Abandoned Sessions =
CALCULATE(
    COUNTROWS(searches_journeys),
    searches_journeys[journey_outcome] = "Abandoned"
)

No Results Sessions =
CALCULATE(
    COUNTROWS(searches_journeys),
    searches_journeys[journey_outcome] = "No Results"
)

// Journey Outcome Rates
Success Rate % =
DIVIDE(
    CALCULATE(COUNTROWS(searches_journeys), searches_journeys[journey_outcome] = "Success"),
    COUNTROWS(searches_journeys),
    0
) * 100

Abandonment Rate % =
DIVIDE(
    CALCULATE(COUNTROWS(searches_journeys), searches_journeys[journey_outcome] = "Abandoned"),
    COUNTROWS(searches_journeys),
    0
) * 100

No Results Rate % =
DIVIDE(
    CALCULATE(COUNTROWS(searches_journeys), searches_journeys[journey_outcome] = "No Results"),
    COUNTROWS(searches_journeys),
    0
) * 100

// Reformulation Rate
Reformulation Rate % =
DIVIDE(
    CALCULATE(COUNTROWS(searches_journeys), searches_journeys[had_reformulation] = TRUE()),
    COUNTROWS(searches_journeys),
    0
) * 100

// Average Timing Metrics
Avg Search to Result (sec) =
AVERAGE(searches_journeys[sec_search_to_result])

Avg Result to Click (sec) =
AVERAGE(searches_journeys[sec_result_to_click])

Avg Session Duration (sec) =
AVERAGE(searches_journeys[total_duration_sec])

// Average Searches per Session (from journeys)
Avg Searches per Session (Journeys) =
AVERAGE(searches_journeys[search_count_in_session])
```

### Setting Up Sort Order for Columns

The bucket and category columns are text and won't sort correctly by default (e.g., "10-30s" would come before "2-5s" alphabetically). The parquet file includes sort order columns to fix this.

**To configure "Sort by column" in Power BI:**

1. Go to **Model view** (left sidebar)
2. Select the text column you want to sort (e.g., `journey_outcome`)
3. In the **Properties** pane, find **Sort by column**
4. Select the corresponding sort column (e.g., `journey_outcome_sort`)

**Column mappings:**

| Text Column | Sort By Column |
|-------------|----------------|
| `journey_outcome` | `journey_outcome_sort` |
| `session_complexity` | `session_complexity_sort` |
| `search_to_result_bucket` | `search_to_result_sort` |
| `result_to_click_bucket` | `result_to_click_sort` |
| `session_duration_bucket` | `session_duration_sort` |

Once configured, the text columns will sort in logical order everywhere they're used.

### Row 1: Journey Outcomes

#### Chart 1: Journey Outcome Distribution
- **Type**: Donut Chart
- **Setup**:
  1. Drag `journey_outcome` to **Legend**
  2. Drag `journey_outcome` to **Values** → select **Count**
- **Colors**:
  - Success = Green (#2E7D32)
  - Abandoned = Orange (#F57C00)
  - No Results = Red (#C62828)
  - Unknown = Gray (#757575)
- **Sort**: Configured via "Sort by column" (see above)

#### Chart 2: Session Complexity Breakdown
- **Type**: Bar Chart
- **Setup**:
  1. Drag `session_complexity` to **Axis**
  2. Drag `session_complexity` to **Values** → select **Count**
- **Sort**: Configured via "Sort by column" (see above)

### Row 2: Timing Analysis

#### Chart 3: Search-to-Result Time Distribution
- **Type**: Bar Chart (Clustered Bar)
- **Setup**:
  1. Drag `search_to_result_bucket` to **Axis**
  2. Drag `search_to_result_bucket` to **Values** → select **Count**
- **Sort**: Configured via "Sort by column" (see above)
- **Insight**: Shows system performance - ideally most sessions should be < 2s

#### Chart 4: Result-to-Click Time Distribution
- **Type**: Bar Chart (Clustered Bar)
- **Setup**:
  1. Drag `result_to_click_bucket` to **Axis**
  2. Drag `result_to_click_bucket` to **Values** → select **Count**
- **Sort**: Configured via "Sort by column" (see above)
- **Insight**: Shows user decision time - quick clicks may indicate good relevance

### Row 3: Behavior Patterns

#### Chart 5: Reformulation Rate
- **Type**: Card or KPI
- **Setup**: Use the `Reformulation Rate %` measure
- **Target**: < 30% is good (users find what they need on first try)
- **Insight**: High reformulation suggests search relevance issues

#### Chart 6: Session Duration Distribution
- **Type**: Bar Chart
- **Setup**:
  1. Drag `session_duration_bucket` to **Axis**
  2. Drag `session_duration_bucket` to **Values** → select **Count**
- **Sort**: Configured via "Sort by column" (see above)
- **Insight**: Very short sessions might be quick successes OR immediate abandonment

### Row 4: KPI Cards (Optional)

Create a row of KPI cards for quick insights:

| Card | Measure | Target |
|------|---------|--------|
| Total Sessions | `Session Count` | - |
| Success Rate | `Success Rate %` | > 40% |
| Avg Searches/Session | `Avg Searches per Session (Journeys)` | < 2 |
| Reformulation Rate | `Reformulation Rate %` | < 30% |
| Avg Time to Click | `Avg Result to Click (sec)` | < 10s |

---

## Page 3: Deep Dive Analysis

### Filters Panel
Add slicers for:
- `session_date` (date range)
- `journey_outcome`
- `session_complexity`
- `search_to_result_bucket`

### Chart 1: Heatmap - Hour of Day Activity
- **Type**: Matrix
- **Rows**: Day of week (from `session_date`)
- **Columns**: `first_event_hour`
- **Values**: Count of sessions
- **Conditional Formatting**: Heat colors

### Chart 2: Click Category by Outcome
- **Type**: Stacked Bar Chart
- **Axis**: `journey_outcome`
- **Legend**: Click type columns
- **Values**: Sum of click counts

### Chart 3: Sessions with Multiple Searches
- **Type**: Histogram or Bar
- **Axis**: `search_count_in_session` (grouped into bins)
- **Values**: Count of sessions
- **Insight**: How often users need multiple searches

---

## Page 4: Search Terms Analysis

### Understanding the Terms File

The `searches_terms.parquet` file contains **one row per search term per day**. It enables analysis of which terms users search for and how successful those searches are.

**Key columns:**

| Column | Type | Description |
|--------|------|-------------|
| `session_date` | Date | Date |
| `search_term` | String | The normalized search query |
| `search_count` | Integer | Times this term was searched |
| `unique_users` | Integer | Distinct users who searched this |
| `unique_sessions` | Integer | Sessions containing this term |
| `result_events` | Integer | Result count events for this term |
| `null_result_count` | Integer | Searches returning 0 results |
| `click_count` | Integer | Clicks attributed to this term |
| `clicks_general` | Integer | General tab clicks |
| `clicks_all` | Integer | All tab clicks |
| `clicks_news` | Integer | News tab clicks |
| `clicks_goto` | Integer | GoTo clicks |
| `clicks_people` | Integer | People clicks |
| `avg_sec_to_click` | Float | Average seconds from result to click |
| `clicks_with_timing` | Integer | Clicks with timing data (for weighting) |
| `sum_sec_to_click` | Float | Sum of seconds to click (for weighted avg) |

### DAX Measures for Search Terms

```dax
// Total searches for all terms
Total Term Searches = SUM(searches_terms[search_count])

// Term CTR (Click-through rate)
Term CTR % =
DIVIDE(
    SUM(searches_terms[click_count]),
    SUM(searches_terms[search_count]),
    0
) * 100

// Zero Result Rate for terms
Term Zero Result Rate % =
DIVIDE(
    SUM(searches_terms[null_result_count]),
    SUM(searches_terms[result_events]),
    0
) * 100

// Term Abandonment Rate (had results but no click)
Term Abandonment Rate % =
DIVIDE(
    SUM(searches_terms[result_events]) - SUM(searches_terms[null_result_count]) - SUM(searches_terms[click_count]),
    SUM(searches_terms[result_events]) - SUM(searches_terms[null_result_count]),
    0
) * 100

// Unique Terms Count
Unique Terms = DISTINCTCOUNT(searches_terms[search_term])

// Weighted Average Time to Click (seconds)
// Uses SUM columns for proper aggregation across dates/terms
Avg Time to Click (sec) =
DIVIDE(
    SUM(searches_terms[sum_sec_to_click]),
    SUM(searches_terms[clicks_with_timing]),
    BLANK()
)
```

### Row 1: Top Search Terms

#### Chart 1: Top 20 Search Terms by Volume
- **Type**: Bar Chart (Horizontal)
- **Setup**:
  1. Drag `search_term` to **Y-axis**
  2. Drag `search_count` to **X-axis** → select **Sum**
  3. Add a **Top N filter** on `search_term` = Top 20 by Sum of `search_count`
- **Sort**: By X-axis values descending

#### Chart 2: Search Term Word Cloud (Optional)
- **Type**: Word Cloud (requires custom visual from AppSource)
- **Category**: `search_term`
- **Values**: `search_count`
- **Note**: Install "Word Cloud" from Power BI AppSource

### Row 2: Problem Terms (Actionable Insights)

#### Chart 3: Terms with High Zero Result Rate
- **Type**: Table
- **Columns**: `search_term`, Sum of `search_count`, `Term Zero Result Rate %`
- **Filter**: `Term Zero Result Rate %` > 50 AND Sum of `search_count` > 5
- **Insight**: Content gaps - these terms need content created

#### Chart 4: High Volume + Low CTR Terms
- **Type**: Table
- **Columns**: `search_term`, Sum of `search_count`, `Term CTR %`
- **Filter**: `Term CTR %` < 20 AND Sum of `search_count` > 10 AND `Term Zero Result Rate %` < 50
- **Insight**: Relevance problems - results exist but don't match user intent

### Row 3: Success Stories

#### Chart 5: High Performing Terms
- **Type**: Table
- **Columns**: `search_term`, Sum of `search_count`, `Term CTR %`
- **Filter**: `Term CTR %` > 50 AND Sum of `search_count` > 10
- **Insight**: Learn from these - what makes them successful?

#### Chart 6: Search Term Trend (Selected Term)
- **Type**: Line Chart
- **Setup**:
  1. Drag `session_date` to **X-axis**
  2. Drag `search_count` to **Y-axis** → select **Sum**
  3. Add a slicer for `search_term` to filter to specific terms
- **Insight**: Track popularity of specific terms over time

### Row 4: KPI Cards

| Card | Measure | Description |
|------|---------|-------------|
| Unique Terms | `Unique Terms` | Total distinct search terms |
| Avg CTR | `Term CTR %` | Overall click-through rate |
| Zero Result Rate | `Term Zero Result Rate %` | % of searches with no results |
| Top Term | First value of `search_term` sorted by `search_count` | Most searched term |

### Key Questions This Page Answers

1. **What are users searching for?** - Top search terms by volume
2. **What content is missing?** - Terms with high zero result rate
3. **Where is relevance poor?** - High volume terms with low CTR
4. **What's working well?** - High CTR terms to learn from
5. **Are search patterns changing?** - Term trends over time

---

## Key Questions This Dashboard Answers

### Daily Trends
1. **How many searches happen per day?** - Search volume trend
2. **Are users finding what they need?** - Click-through rate trend
3. **Is content missing?** - Null result rate trend
4. **What content types are most clicked?** - Click category breakdown

### User Behavior
1. **What percentage of searches succeed?** - Journey outcome distribution
2. **How complex are search sessions?** - Session complexity breakdown
3. **Do users refine their searches?** - Reformulation rate
4. **How long do users take to decide?** - Result-to-click timing

### System Performance
1. **How fast do results appear?** - Search-to-result timing
2. **Are there performance issues?** - Sessions in slow timing buckets

---

## Recommended Alerts

Set up Power BI alerts for:

| Alert | Threshold | Meaning |
|-------|-----------|---------|
| Null Rate Spike | > 15% | Content gap or search issues |
| Session Success Drop | < 30% | Results not matching user intent |
| Session Abandonment Spike | > 70% | Results showing but not useful |
| Slow Results | > 10% in "> 5s" bucket | System performance issue |

---

## Color Scheme Recommendations

| Metric Type | Good | Warning | Bad |
|-------------|------|---------|-----|
| Session Success Rate % | > 40% (Green) | 25-40% (Yellow) | < 25% (Red) |
| Null Rate % | < 5% (Green) | 5-15% (Yellow) | > 15% (Red) |
| Session Abandonment % | < 50% (Green) | 50-70% (Yellow) | > 70% (Red) |
| Click Rate % | > 30% (Green) | 15-30% (Yellow) | < 15% (Red) |

---

## Tips for Effective Analysis

1. **Compare weekdays vs weekends** - Search patterns differ
2. **Filter by time of day** - Peak hours may show different behavior
3. **Track reformulation rate** - High rates suggest search UI/relevance issues
4. **Monitor null results** - These are opportunities to improve content
5. **Watch for "quick clicks" (< 2s)** - May indicate good results OR users just clicking first result
6. **Look for "extended sessions" (> 5 min)** - Users may be struggling to find content

---

## Sample Report Layout

```
+------------------------------------------------------------------------+
|  [Total Searches]  [Unique Users]  [Success %]  [Null %]  [Abandon %]  |
+------------------------------------------------------------------------+
|                                          |                              |
|     Search Volume Over Time              |   Click Category             |
|     (Line Chart)                         |   Distribution               |
|                                          |   (Donut)                    |
+------------------------------------------+------------------------------+
|                                          |                              |
|     Quality Metrics Over Time            |   Journey Outcomes           |
|     (Multi-line: Success, Null, Abandon) |   (Donut)                    |
|                                          |                              |
+------------------------------------------+------------------------------+
|                                                                         |
|     Daily Details Table                                                 |
|     (Date, Searches, Users, Success%, Null%, etc.)                     |
|                                                                         |
+------------------------------------------------------------------------+
```

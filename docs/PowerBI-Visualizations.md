# Power BI Visualization Guide for Search Analytics

This guide provides recommended visualizations for analyzing Intranet search behavior using the parquet files generated by the processing script.

---

## Data Sources Setup

### Connecting to Parquet Files
1. **Get Data** > **Parquet**
2. Navigate to `output/` folder
3. Load both files:
   - `searches_daily.parquet` - Daily aggregated metrics
   - `searches_journeys.parquet` - Session-level data

---

## Important: Handling Pre-Calculated Rates and Averages

### The Aggregation Problem

The daily parquet file contains pre-calculated rate and average columns for convenience when viewing single-day data. However, **these columns cannot be correctly aggregated across multiple days** using simple SUM or AVERAGE functions.

**Why?** Averaging percentages or ratios gives mathematically incorrect results:
- Day 1: 50 clicks / 100 searches = 50% CTR
- Day 2: 10 clicks / 200 searches = 5% CTR
- Wrong: Average of 50% and 5% = 27.5%
- Correct: (50 + 10) / (100 + 200) = 20%

### Columns That Cannot Be Directly Aggregated

| Column | Type | Problem |
|--------|------|---------|
| `click_through_rate_pct` | Ratio | Cannot average percentages |
| `null_rate_pct` | Ratio | Cannot average percentages |
| `abandonment_rate_pct` | Ratio | Cannot average percentages |
| `avg_searches_per_session` | Average | Cannot average averages |
| `avg_search_term_length` | Average | Cannot average averages |
| `avg_search_term_words` | Average | Cannot average averages |

### Solution: Create DAX Measures

Instead of using the pre-calculated columns, create DAX measures that recalculate from the component columns. The daily file includes all necessary building blocks.

#### Rate Metrics - DAX Formulas

```dax
// Click-Through Rate (correct across any date range)
CTR % =
DIVIDE(
    SUM(searches_daily[click_events]),
    SUM(searches_daily[search_starts]),
    0
) * 100

// Null Result Rate
Null Rate % =
DIVIDE(
    SUM(searches_daily[null_results]),
    SUM(searches_daily[result_events]),
    0
) * 100

// Abandonment Rate
Abandonment Rate % =
DIVIDE(
    SUM(searches_daily[clickable_results]) - SUM(searches_daily[click_events]),
    SUM(searches_daily[clickable_results]),
    0
) * 100
```

#### Average Metrics - DAX Formulas

```dax
// Average Searches per Session
Avg Searches per Session =
DIVIDE(
    SUM(searches_daily[search_starts]),
    SUM(searches_daily[unique_sessions]),
    0
)

// Average Search Term Length (weighted average using SUM columns)
Avg Search Term Length =
DIVIDE(
    SUM(searches_daily[sum_search_term_length]),
    SUM(searches_daily[search_term_count]),
    0
)

// Average Search Term Words (weighted average using SUM columns)
Avg Search Term Words =
DIVIDE(
    SUM(searches_daily[sum_search_term_words]),
    SUM(searches_daily[search_term_count]),
    0
)
```

### Component Columns Reference

| Metric to Calculate | Numerator Column | Denominator Column |
|---------------------|------------------|-------------------|
| CTR % | `click_events` | `search_starts` |
| Null Rate % | `null_results` | `result_events` |
| Abandonment Rate % | `clickable_results - click_events` | `clickable_results` |
| Avg Searches/Session | `search_starts` | `unique_sessions` |
| Avg Search Term Length | `sum_search_term_length` | `search_term_count` |
| Avg Search Term Words | `sum_search_term_words` | `search_term_count` |

### When to Use Pre-Calculated vs DAX Measures

| Scenario | Use Pre-Calculated Column | Use DAX Measure |
|----------|---------------------------|-----------------|
| Single day view (date slicer = 1 day) | OK | OK |
| Multiple days aggregated | NO | YES |
| Weekly/Monthly totals | NO | YES |
| Filtering by other dimensions | NO | YES |
| Quick glance at daily table | OK | OK |

### Best Practice

**Always use DAX measures for KPI tiles and aggregated views.** The pre-calculated columns are useful for:
- Quick reference in detailed daily tables
- Validation that your DAX measures match single-day values
- Export to other tools that will handle aggregation separately

---

## Page 1: Executive Dashboard (Daily Metrics)

### Row 1: KPI Tiles

| Tile | Measure | Description |
|------|---------|-------------|
| **Total Searches** | `SUM(search_starts)` | Total search queries |
| **Unique Users** | `SUM(unique_users)` | Distinct users who searched |
| **Click-Through Rate** | See DAX below | Percentage of searches that led to clicks |
| **Null Result Rate** | See DAX below | Percentage of searches with zero results |
| **Abandonment Rate** | See DAX below | Percentage of results shown but not clicked |

#### DAX Measures for Correct Aggregation

```dax
// Click-Through Rate (recalculated for correct aggregation)
CTR % =
DIVIDE(
    SUM(searches_daily[click_events]),
    SUM(searches_daily[search_starts]),
    0
) * 100

// Null Result Rate
Null Rate % =
DIVIDE(
    SUM(searches_daily[null_results]),
    SUM(searches_daily[result_events]),
    0
) * 100

// Abandonment Rate
Abandonment Rate % =
DIVIDE(
    SUM(searches_daily[clickable_results]) - SUM(searches_daily[click_events]),
    SUM(searches_daily[clickable_results]),
    0
) * 100

// Average Searches per Session
Avg Searches/Session =
DIVIDE(
    SUM(searches_daily[search_starts]),
    SUM(searches_daily[unique_sessions]),
    0
)

// Average Search Term Length (weighted)
Avg Search Term Length =
DIVIDE(
    SUM(searches_daily[sum_search_term_length]),
    SUM(searches_daily[search_term_count]),
    0
)
```

### Row 2: Trend Charts

#### Chart 1: Search Volume Over Time
- **Type**: Line Chart
- **X-Axis**: `date`
- **Y-Axis**: `search_starts`
- **Secondary Y-Axis** (optional): `unique_users`

#### Chart 2: Quality Metrics Over Time
- **Type**: Line Chart (multiple series)
- **X-Axis**: `date`
- **Lines**:
  - `CTR %` (DAX measure)
  - `Null Rate %` (DAX measure)
  - `Abandonment Rate %` (DAX measure)

### Row 3: Click Distribution

#### Chart 3: Clicks by Category
- **Type**: Stacked Bar Chart or Donut
- **Values**:
  - `clicks_general`
  - `clicks_all`
  - `clicks_news`
  - `clicks_goto`
  - `clicks_people`

#### Chart 4: Daily Activity Table
- **Type**: Table
- **Columns**: `date`, `search_starts`, `unique_users`, `CTR %`, `Null Rate %`
- **Conditional Formatting**: Highlight low CTR or high null rates

---

## Page 2: User Journey Analysis (Session Metrics)

### Row 1: Journey Outcomes

#### Chart 1: Journey Outcome Distribution
- **Type**: Donut Chart
- **Legend**: `journey_outcome`
- **Values**: Count of rows
- **Colors**:
  - Success = Green
  - Abandoned = Yellow/Orange
  - No Results = Red
  - Unknown = Gray

```dax
// Journey counts by outcome
Success Count = CALCULATE(COUNTROWS(searches_journeys), searches_journeys[journey_outcome] = "Success")
Abandoned Count = CALCULATE(COUNTROWS(searches_journeys), searches_journeys[journey_outcome] = "Abandoned")
No Results Count = CALCULATE(COUNTROWS(searches_journeys), searches_journeys[journey_outcome] = "No Results")
```

#### Chart 2: Session Complexity Breakdown
- **Type**: Bar Chart
- **Axis**: `session_complexity`
- **Values**: Count of rows
- **Sort Order**: Single Event > Simple > Medium > Complex

### Row 2: Timing Analysis

#### Chart 3: Search-to-Result Time Distribution
- **Type**: Bar Chart
- **Axis**: `search_to_result_bucket`
- **Values**: Count of rows
- **Insight**: Shows system performance - how fast results appear

#### Chart 4: Result-to-Click Time Distribution
- **Type**: Bar Chart
- **Axis**: `result_to_click_bucket`
- **Values**: Count of rows
- **Insight**: Shows user decision time - how long to evaluate results

### Row 3: Behavior Patterns

#### Chart 5: Reformulation Rate
- **Type**: KPI or Gauge
- **Value**: Percentage of sessions with `had_reformulation = true`

```dax
Reformulation Rate % =
DIVIDE(
    CALCULATE(COUNTROWS(searches_journeys), searches_journeys[had_reformulation] = TRUE()),
    COUNTROWS(searches_journeys),
    0
) * 100
```

#### Chart 6: Session Duration Distribution
- **Type**: Bar Chart
- **Axis**: `session_duration_bucket`
- **Values**: Count of rows

---

## Page 3: Deep Dive Analysis

### Filters Panel
Add slicers for:
- `session_date` (date range)
- `journey_outcome`
- `session_complexity`
- `search_to_result_bucket`

### Chart 1: Heatmap - Hour of Day Activity
- **Type**: Matrix
- **Rows**: Day of week (from `session_date`)
- **Columns**: `first_event_hour`
- **Values**: Count of sessions
- **Conditional Formatting**: Heat colors

### Chart 2: Click Category by Outcome
- **Type**: Stacked Bar Chart
- **Axis**: `journey_outcome`
- **Legend**: Click type columns
- **Values**: Sum of click counts

### Chart 3: Sessions with Multiple Searches
- **Type**: Histogram or Bar
- **Axis**: `search_count_in_session` (grouped into bins)
- **Values**: Count of sessions
- **Insight**: How often users need multiple searches

---

## Key Questions This Dashboard Answers

### Daily Trends
1. **How many searches happen per day?** - Search volume trend
2. **Are users finding what they need?** - Click-through rate trend
3. **Is content missing?** - Null result rate trend
4. **What content types are most clicked?** - Click category breakdown

### User Behavior
1. **What percentage of searches succeed?** - Journey outcome distribution
2. **How complex are search sessions?** - Session complexity breakdown
3. **Do users refine their searches?** - Reformulation rate
4. **How long do users take to decide?** - Result-to-click timing

### System Performance
1. **How fast do results appear?** - Search-to-result timing
2. **Are there performance issues?** - Sessions in slow timing buckets

---

## Recommended Alerts

Set up Power BI alerts for:

| Alert | Threshold | Meaning |
|-------|-----------|---------|
| Null Rate Spike | > 15% | Content gap or search issues |
| CTR Drop | < 20% | Results not matching user intent |
| Abandonment Spike | > 70% | Results showing but not useful |
| Slow Results | > 10% in "> 5s" bucket | System performance issue |

---

## Color Scheme Recommendations

| Metric Type | Good | Warning | Bad |
|-------------|------|---------|-----|
| CTR % | > 30% (Green) | 15-30% (Yellow) | < 15% (Red) |
| Null Rate % | < 5% (Green) | 5-15% (Yellow) | > 15% (Red) |
| Abandonment % | < 50% (Green) | 50-70% (Yellow) | > 70% (Red) |
| Success Rate | > 40% (Green) | 25-40% (Yellow) | < 25% (Red) |

---

## Tips for Effective Analysis

1. **Compare weekdays vs weekends** - Search patterns differ
2. **Filter by time of day** - Peak hours may show different behavior
3. **Track reformulation rate** - High rates suggest search UI/relevance issues
4. **Monitor null results** - These are opportunities to improve content
5. **Watch for "quick clicks" (< 2s)** - May indicate good results OR users just clicking first result
6. **Look for "extended sessions" (> 5 min)** - Users may be struggling to find content

---

## Sample Report Layout

```
+------------------------------------------------------------------+
|  [Total Searches]  [Unique Users]  [CTR %]  [Null %]  [Abandon%] |
+------------------------------------------------------------------+
|                                          |                        |
|     Search Volume Over Time              |   Click Category       |
|     (Line Chart)                         |   Distribution         |
|                                          |   (Donut)              |
+------------------------------------------+------------------------+
|                                          |                        |
|     Quality Metrics Over Time            |   Journey Outcomes     |
|     (Multi-line: CTR, Null, Abandon)     |   (Donut)              |
|                                          |                        |
+------------------------------------------+------------------------+
|                                                                   |
|     Daily Details Table                                           |
|     (Date, Searches, Users, CTR%, Null%, etc.)                   |
|                                                                   |
+------------------------------------------------------------------+
```
